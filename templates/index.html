{% extends "base.html" %}
{% block title %}Chatbot Zezim{% endblock %}

{% block content %}
<div class="layout">
  <section class="chat-panel">
    <div class="chat-header">
      <div>
        <h1>Chatbot Zezim</h1>
        <p class="muted">
          FaÃ§a perguntas livres ou, se configurado, dentro do contexto da sua empresa/documento.
        </p>
      </div>
      <button id="resetChat" class="btn-secondary small">Limpar conversa</button>
    </div>

    <div id="chatWindow" class="chat-window">
      <div class="message bot">
        <div class="avatar">ðŸ¤–</div>
        <div class="bubble">
          OlÃ¡! Eu sou o Chatbot Zezim. Como posso ajudar hoje?
        </div>
      </div>
    </div>

    <form id="chatForm" class="chat-input-area">

      <!-- BotÃ£o de Ã¡udio -->
      <button type="button" id="micBtn" class="mic-btn" title="Fazer pergunta por voz">
        ðŸŽ¤
      </button>

      <!-- Campo de texto -->
      <textarea
        id="messageInput"
        rows="2"
        placeholder="Digite sua pergunta ou use o microfone..."
      ></textarea>

      <button type="submit" class="btn-primary">Enviar</button>
    </form>
  </section>

  <aside class="config-panel">
    <h2>ConfiguraÃ§Ãµes</h2>

    {% if logged_in %}
      <p class="muted">
        VocÃª estÃ¡ logado. Aqui vocÃª pode controlar a personalidade do Zezim e o contexto de empresa/documento.
      </p>

      <!-- FORM PRINCIPAL: personalidade, modo e upload de arquivos -->
      <form method="post" action="{{ url_for('config') }}" enctype="multipart/form-data" class="form">

        <label class="form-label">
          Personalidade do Chatbot Zezim
          <textarea
            name="persona_text"
            rows="6"
            class="input textarea"
          >{{ persona_text }}</textarea>
          <span class="help-text">
            Descreva como o Zezim deve se comportar (tom de voz, estilo de resposta, pÃºblico-alvo, etc.).
          </span>
        </label>

        <label class="form-label">
          Modo de resposta
          <select name="mode" class="input">
            <option value="no_context" {% if mode == "no_context" %}selected{% endif %}>
              Apenas personalidade (sem arquivo)
            </option>
            <option value="context" {% if mode == "context" %}selected{% endif %}>
              Somente contexto de empresa/documento (modo restrito)
            </option>
            <option value="both" {% if mode == "both" %}selected{% endif %}>
              Personalidade + contexto de empresa (arquivo)
            </option>
          </select>
          <span class="help-text">
            â€¢ <strong>Apenas personalidade:</strong> Zezim responde livre, sem usar arquivo.<br>
            â€¢ <strong>Somente contexto:</strong> Zezim responde <u>apenas</u> com base nos arquivos enviados.<br>
            â€¢ <strong>Personalidade + contexto:</strong> Zezim prioriza os arquivos, mas pode complementar com conhecimento geral.
          </span>
        </label>

        <!-- ARQUIVOS DE CONTEXTO: mÃºltiplos -->
        <label class="form-label">
          Arquivo(s) de contexto (.txt ou .pdf)
          <input type="file" name="context_files" class="input" multiple>
          <span class="help-text">
            VocÃª pode selecionar um ou vÃ¡rios arquivos de uma vez. Eles serÃ£o usados como base de conhecimento do Zezim.
          </span>
        </label>

        <!-- BotÃ£o de salvar configuraÃ§Ãµes -->
        <button type="submit" class="btn-secondary full">
          Salvar configuraÃ§Ãµes
        </button>
      </form>

      <!-- LISTA DE ARQUIVOS + FORM DE REMOÃ‡ÃƒO (FORA DO FORM PRINCIPAL) -->
      {% if context_files %}
        <div class="context-list">
          <span class="help-text">Arquivos de contexto carregados:</span>
          <ul>
            {% for f in context_files %}
              <li class="small-text">â€¢ {{ f.name }}</li>
            {% endfor %}
          </ul>

          <form method="post" action="{{ url_for('remove_context') }}" class="context-remove-form">
            <label class="form-label">
              Remover arquivo de contexto
              <select name="file_id" class="input">
                {% for f in context_files %}
                  <option value="{{ f.id }}">{{ f.name }}</option>
                {% endfor %}
              </select>
            </label>
            <button type="submit" class="btn-danger small">
              Remover arquivo
            </button>
          </form>
        </div>
      {% else %}
        <span class="badge">Nenhum arquivo carregado.</span>
      {% endif %}

    {% else %}
      <p class="muted">
        Para alterar a personalidade do Zezim ou adicionar contexto de empresa/documento,
        faÃ§a login.
      </p>
      <a href="{{ url_for('login') }}" class="btn-primary full">Entrar na Ã¡rea admin</a>
    {% endif %}

    <div class="info-box">
      <h3>ðŸ§  Modo atual</h3>

      <p>
        <strong>Personalidade:</strong><br>
        <span class="small-text">{{ persona_text }}</span>
      </p>

      <p>
        <strong>Contexto:</strong>
        {% if has_context %}
          <span class="badge good">Carregado</span>
        {% else %}
          <span class="badge">Nenhum</span>
        {% endif %}
      </p>

      <p class="small-text" style="margin-top:6px;">
        Modo selecionado:
        {% if mode == "no_context" %}
          Apenas personalidade.
        {% elif mode == "context" %}
          Somente contexto de empresa/documento (restrito).
        {% elif mode == "both" %}
          Personalidade + contexto de empresa (arquivo).
        {% else %}
          (nÃ£o definido)
        {% endif %}
      </p>
    </div>
  </aside>
</div>

<script>
  // ===========================
  // REFERÃŠNCIAS DOS ELEMENTOS
  // ===========================
  const chatForm = document.getElementById("chatForm");
  const messageInput = document.getElementById("messageInput");
  const chatWindow = document.getElementById("chatWindow");
  const resetBtn = document.getElementById("resetChat");
  const micBtn = document.getElementById("micBtn");

  // ===========================
  // FUNÃ‡ÃƒO UTILITÃRIA: ADICIONAR MENSAGEM
  // ===========================
  function appendMessage(text, sender) {
    const wrapper = document.createElement("div");
    wrapper.classList.add("message", sender);

    const avatar = document.createElement("div");
    avatar.classList.add("avatar");
    avatar.textContent = sender === "user" ? "ðŸ§‘" : "ðŸ¤–";

    const bubble = document.createElement("div");
    bubble.classList.add("bubble");
    bubble.textContent = text;

    wrapper.appendChild(avatar);
    wrapper.appendChild(bubble);
    chatWindow.appendChild(wrapper);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  // ===========================
  // ENVIO DE MENSAGENS (TEXTO)
  // ===========================
  chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text) return;

    appendMessage(text, "user");
    messageInput.value = "";
    messageInput.focus();

    const typing = document.createElement("div");
    typing.classList.add("message", "bot");
    typing.innerHTML = '<div class="avatar">ðŸ¤–</div><div class="bubble">Pensando...</div>';
    chatWindow.appendChild(typing);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    try {
      const resp = await fetch("{{ url_for('chat') }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ message: text })
      });

      const data = await resp.json();
      chatWindow.removeChild(typing);

      if (data.reply) {
        appendMessage(data.reply, "bot");
      } else if (data.error) {
        appendMessage("Erro do servidor: " + data.error, "bot");
      } else {
        appendMessage("Ocorreu um erro ao obter resposta.", "bot");
      }
    } catch (err) {
      chatWindow.removeChild(typing);
      appendMessage("Erro de rede ao falar com o servidor.", "bot");
    }
  });

  // ===========================
  // RESETAR CONVERSA
  // ===========================
  resetBtn.addEventListener("click", async () => {
    try {
      await fetch("{{ url_for('reset_chat') }}", {
        method: "POST"
      });
      chatWindow.innerHTML = "";
      appendMessage(
        "Conversa limpa! O Zezim tÃ¡ pronto pra comeÃ§ar de novo. ðŸ˜Š",
        "bot"
      );
    } catch (err) {
      appendMessage("NÃ£o foi possÃ­vel limpar a conversa.", "bot");
    }
  });

  // ===========================
  // ENTER = ENVIAR (SEM SHIFT)
  // ===========================
  messageInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      chatForm.dispatchEvent(new Event("submit"));
    }
  });

  // ===========================
  // RECONHECIMENTO DE VOZ ðŸŽ¤
  // ===========================
  let recognition = null;
  let isRecording = false;

  if ("webkitSpeechRecognition" in window) {
    recognition = new webkitSpeechRecognition();
  } else if ("SpeechRecognition" in window) {
    recognition = new SpeechRecognition();
  }

  if (recognition) {
    recognition.lang = "pt-BR";
    recognition.continuous = false;
    recognition.interimResults = true;

    recognition.onstart = function () {
      isRecording = true;
      micBtn.classList.add("recording");
      micBtn.textContent = "ðŸ”´";
    };

    recognition.onerror = function () {
      isRecording = false;
      micBtn.classList.remove("recording");
      micBtn.textContent = "ðŸŽ¤";
    };

    recognition.onend = function () {
      isRecording = false;
      micBtn.classList.remove("recording");
      micBtn.textContent = "ðŸŽ¤";
    };

    recognition.onresult = function (event) {
      let text = "";

      for (let i = 0; i < event.results.length; i++) {
        text += event.results[i][0].transcript;
      }

      messageInput.value = text;
      messageInput.focus();
    };
  }

  micBtn.addEventListener("click", () => {
    if (!recognition) {
      alert("Seu navegador nÃ£o suporta reconhecimento de voz.\nUse Chrome ou Edge. ðŸ˜¢");
      return;
    }

    if (!isRecording) {
      recognition.start();
    } else {
      recognition.stop();
    }
  });
</script>
{% endblock %}
